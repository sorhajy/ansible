- name: Install Redis
  become: true
  apt: 
    name: redis
    state: present
- name: Configure Redis password
  become: true
  ansible.builtin.lineinfile:
    path: /etc/redis/redis.conf
    regexp: '^# requirepass foobared'
    line: "requirepass {{ redis_password }}"
    owner: redis
    group: redis
    mode: '0640'
- name: Configure Redis listen interface
  become: true
  ansible.builtin.lineinfile:
    path: /etc/redis/redis.conf
    regexp: '^bind 127.0.0.1 ::1'
    line: "# bind 127.0.0.1 ::1"
    owner: redis
    group: redis
    mode: '0640'
- name: Disable autostart & stop Redis
  become: true
  service:
    name: redis-server
    enabled: no
    state: stopped


- name: Install PostgreSQL
  become: true
  apt: 
    name: "{{ packages }}"
    state: present
  vars:
    packages:
    - postgresql
    - postgresql-contrib
    - postgresql-common
    - postgresql-client
    - postgresql-client-common
    - python3-psycopg2
- name: Disable autoload & stop PostgreSQL service
  become: true
  service:
    name: postgresql
    enabled: no
    state: stopped


- name: Install MySQL
  become: true
  apt: 
    name: "{{ packages }}"
    state: present
  vars:
    packages:
      - default-mysql-server
      - default-mysql-client
      - python3-pymysql
- name: Set MySQL root Password
  become: true
  mysql_user:
    login_unix_socket: "/var/run/mysqld/mysqld.sock"
    name: "root"
    password: "{{ mysql_root_password }}"
    state: present
- name: Disable autoload & stop MySQL service
  become: true
  service:
    name: mysql
    state: stopped
    enabled: no


- name: Add ClickHouse GPG key
  become: true
  apt_key:
    keyserver: keyserver.ubuntu.com
    id: E0C56BD4
- name: Add ClickHouse repo
  become: true
  apt_repository:
    repo: "deb http://repo.yandex.ru/clickhouse/deb/stable/ main/"
    state: present
- name: Install ClickHouse
  become: true
  apt: 
    name: "{{ packages }}"
    state: present
    update_cache: true
  vars:
    packages:
      - clickhouse-server
      - clickhouse-client
- name: Configure ClickHouse user
  become: true
  template:
    src: roles/ubuntu-server/templates/clickhouse_user.xml.j2
    dest: /etc/clickhouse-server/users.d/{{ clickhouse_user }}.xml
- name: Disable autoload & stop ClickHouse service
  become: true
  service:
    name: clickhouse-server
    state: stopped
    enabled: no
